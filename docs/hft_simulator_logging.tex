\documentclass[11pt]{article}
\usepackage[margin=1.2in]{geometry}
\usepackage{color,soul,hyperref,url}
\usepackage{graphicx,amstext}
\usepackage{subfigure}
\usepackage{amsmath}
\usepackage{enumerate}
\def\newblock{}

\newcommand{\bid}{\ensuremath{\mathit BID}}
\newcommand{\ask}{\ensuremath{\mathit ASK}}
\newcommand{\PV}{\ensuremath{\mathit PV}}
\providecommand{\floor}[1]{\lfloor#1\rfloor}
\providecommand{\ceil}[1]{\lceil#1\rceil}

\begin{document}
	
\title{HFT Simulation System \\
Part II: Logging}
%\numberofauthors{1}
\author{
%\alignauthor
Elaine Wah\\
\href{mailto:ewah@umich.edu}{ewah@umich.edu}
}
\date{Updated: May 2013}
\maketitle


% ---------------------
%\section{Example: Running more complex experiments}
%
%To run a basic simulation, first compile the code (run \verb|ant| in the base directory that contains the \verb|build.xml| file. Then use the following command:
%\begin{verbatim}
%./example.sh <HFT type> <NBBO latency> <number of samples> <CSV>
%\end{verbatim}
%For example:
%\begin{verbatim}
%./example.sh LA 0 10 test.csv
%\end{verbatim}


%
%All simulations should be saved within subfolders in the \verb|simulations| directory.
%%The \verb|example.sh| script saves all observations in \verb|[HFT type]\_latency\_[NBBO latency]|.
%In the previous example, the \verb|example.sh| script will generate a folder with path \verb|simulations\LA_latency_0|.
%The resulting simulations will be parsed and saved in a CSV file in the base directory.

%% ---------------------
%\section{Log file}

All log files are saved in the folder \verb|logs| that is created in the directory that contains the \verb|simulation_spec.json| file.
Logs (.txt files) are named according the following convention: There are four sections in the filename, each separated by underscores (examples refer to the filename \verb|simulations-test_2_12-Feb-2013_13.45.00.txt|):
\begin{enumerate}[(1)]
\item \emph{Directory or path} with the spec file, with forward slashes replaced by hyphens (e.g., the base directory is \verb|simulations/test|)
\item \emph{Observation number} (e.g., here it is observation \#2)
\item \emph{Date} (dd-MMM-YYYY format)
\item \emph{Time} (hh.mm.ss format, 24-hour clock, e.g., time here is 1:45:00 PM)
\end{enumerate}

Within the log files, the first 18 characters on each line can be ignored, as they are just generated by the logging utility.
%
There are three parts for the log file, which are described in depth in the following sections. Some basic aspects to be aware of:

\begin{itemize}
\item Model IDs are within curly brackets, e.g. \verb|{1}|.

\item Market IDs are negative, and are within square brackets, e.g., \verb|[-1]|.

\item Agent IDs are positive, and are within parentheses, e.g., \verb|(1)|; each agent has a \emph{unique} agent ID.

\item Agents are assigned \emph{log IDs} in addition to agent IDs, which are used to identify agents that have common random numbers (and therefore the same arrival time and private valuation, among other properties) across multiple market models. Therefore, multiple agents may have the same log ID.

Log IDs are also enclosed within parentheses, but unlike agent IDs, they are followed by the corresponding model ID, e.g. \verb|(1,{2})| indicates an agent with the first common random number generator seed (log ID of \verb|1|) that is in the second market model.
\end{itemize}

Note that within the \verb|config| directory there is a file called \verb|env.properties|, which is used to specify the logging level. Log level $2$ will be adequate for most debugging purposes.
%
While printing to \verb|System.out| will be useful for initial debugging, looking at the logs and observation files will be necessary in order to verify that agents are behaving as expected.

\section{Configuration file: Multiple market models}

The log file excerpted in the following sections was generated using the following \path{simulation_spec.json} file for the market models use case:
\begin{verbatim}
{"assignment": {
},
"configuration": {
"sim_length": "15000",
"primary_model": "CENTRALCDA",
"TWOMARKET": "LA:sleepTime_0_alpha_0.001,DUMMY",
"CENTRALCDA": "1",
"CENTRALCALL": "NBBO",
"BASICMM": "0",
"BASICMM_setup": "",
"ZI": "5",
"ZI_setup": "bidRange_2000",
"ZIR": "0",
"ZIR_setup": "bidRange_2000_maxqty_5",
"ZIP": "0",
"ZIP_setup": "",
"AA": "0",
"AA_setup": "",
"tick_size": "1",
"nbbo_latency": "0",
"arrival_rate": "0.075",
"reentry_rate": "0.005",
"mean_value": "100000",
"kappa": "0.05",
"shock_var": "150000000",
"private_value_var": "100000000",
} }
\end{verbatim}

\section{Market model creation}

When market models are created, the following are specified: (1) number and type of each model, (2) Model configuration and model ID (in curly brackets), and (3) markets in each model and the market IDs (in square brackets).
%
For example: 
\begin{description}
\item \verb|Models: 2 TWOMARKET|  --- there are 2 instances of the TwoMarket model.
\item \verb|TWOMARKET-LA: {2} {config=LA:sleepTime_0_alpha_0.001}|  --- one instance is specified by configuration string \verb|LA:...| (recall this was given in the spec file). The name of this model instance is ``TWOMARKET-LA'' and the model ID is 2 (in curly brackets).

\item \verb|Markets: CDA, [-2]| --- within the TwoMarket model, there is a CDA with ID=$-2$ 
\end{description}

An example of a complete market model creation sequence is given below:
\begin{verbatim}
1369933844584|X|2|------------------------------------------------
1369933844584|X|2|            Creating MARKET MODELS
1369933844584|X|2|Models: 1 CENTRALCDA
1369933844586|X|2|CENTRALCDA: {1} {config=1}
1369933844590|X|2|Markets: CDA, [-1]
1369933844591|X|2|Models: 2 TWOMARKET
1369933844591|X|2|TWOMARKET-LA: {2} {config=LA:sleepTime_0_alpha_0.001}
1369933844591|X|2|Markets: CDA, [-2]
1369933844591|X|2|Markets: CDA, [-3]
1369933844591|X|2|TWOMARKET-DUMMY: {3} {config=DUMMY}
1369933844591|X|2|Markets: CDA, [-4]
1369933844591|X|2|Markets: CDA, [-5]
1369933844591|X|2|Models: 1 CENTRALCALL
1369933844591|X|2|CENTRALCALL-NBBO: {4} {config=NBBO}
1369933844593|X|2|Markets: CALL, [-6]
\end{verbatim}

\section{Agent creation \& initialization}

\subsection{Agent creation}
Agents are created for each model, based on the model's configuration. This section lists the number of each type of agent within a model, as well as the strategies associated with any (HFT) agents in a model (set in the spec file).

An example of a complete agent creation sequence is given below.
In thix example, in each model there are 5 ZI agents, and the LA agent is only present in TWOMARKET-LA:
\begin{verbatim}
1369933844593|X|2|------------------------------------------------
1369933844593|X|2|            Creating AGENTS
1369933844594|X|2|MODEL: CENTRALCDA agent types:
1369933844602|X|2|Agents: 5 ZI {bidRange=2000}
1369933844602|X|2|Agents: 0 ZIP {sleepVar=100, gamma=0.5, betaVar=0.005, 
sleepTime=50, c_R=0.05, c_A=0.05, beta=0.03}
1369933844602|X|2|Agents: 0 AA {bidRange=200}
1369933844602|X|2|Agents: 0 ZIR {bidRange=2000, maxqty=5}
1369933844602|X|2|Agents: 0 BASICMM {sleepVar=100, numRungs=10, sleepTime=200, 
rungSize=1000}
1369933844603|X|2|MODEL: TWOMARKET-LA agent types:
1369933844603|X|2|Agents: 5 ZI {bidRange=2000}
1369933844604|X|2|Agents: 0 ZIP {sleepVar=100, gamma=0.5, betaVar=0.005, 
sleepTime=50, c_R=0.05, c_A=0.05, beta=0.03}
1369933844604|X|2|Agents: 0 AA {bidRange=200}
1369933844604|X|2|Agents: 1 LA {sleepVar=100, sleepTime=0, alpha=0.001}
1369933844604|X|2|Agents: 0 ZIR {bidRange=2000, maxqty=5}
1369933844604|X|2|Agents: 0 BASICMM {sleepVar=100, numRungs=10, sleepTime=200, 
rungSize=1000}
1369933844604|X|2|MODEL: TWOMARKET-DUMMY agent types:
1369933844605|X|2|Agents: 5 ZI {bidRange=2000}
1369933844605|X|2|Agents: 0 ZIP {sleepVar=100, gamma=0.5, betaVar=0.005, 
sleepTime=50, c_R=0.05, c_A=0.05, beta=0.03}
1369933844605|X|2|Agents: 0 AA {bidRange=200}
1369933844605|X|2|Agents: 0 ZIR {bidRange=2000, maxqty=5}
1369933844606|X|2|Agents: 1 DUMMY {}
1369933844606|X|2|Agents: 0 BASICMM {sleepVar=100, numRungs=10, sleepTime=200, 
rungSize=1000}
1369933844606|X|2|MODEL: CENTRALCALL-NBBO agent types:
1369933844607|X|2|Agents: 5 ZI {bidRange=2000}
1369933844607|X|2|Agents: 0 ZIP {sleepVar=100, gamma=0.5, betaVar=0.005, 
sleepTime=50, c_R=0.05, c_A=0.05, beta=0.03}
1369933844607|X|2|Agents: 0 AA {bidRange=200}
1369933844607|X|2|Agents: 0 ZIR {bidRange=2000, maxqty=5}
1369933844607|X|2|Agents: 0 BASICMM {sleepVar=100, numRungs=10, sleepTime=200, 
rungSize=1000}
\end{verbatim}


\subsection{Agent initialization}
During agent initialization, agents are assigned: (1) arrival times; (2) private valuations, if they have one; (3) agent IDs; and (4) log IDs.
The general format for logging agent initialization is:
\begin{verbatim}
<agentID>: (<logID>,{modelID})::<type>::arrivalTime=<time>, pv=<private value>
... params={<parameter_n>=<value_n>}
\end{verbatim}
A partial example of agent initialization logging follows (for a simulation with 5 ZI agents and a single LA agent in market model \#2, the two-market model with LA):
\begin{verbatim}
1369933844607|X|2| 1: (1,{1})::ZI::arrivalTime=1, pv=[[809, -15701]] ... 
params={bidRange=2000, marketID=-1, arrivalTime=1, seed=1511539776185465446, 
fundamentalAtArrival=129299}
1369933844607|X|2| 2: (2,{1})::ZI::arrivalTime=4, pv=[[6490, -8052]] ... 
params={bidRange=2000, marketID=-1, arrivalTime=4, seed=-8400005381541772898, 
fundamentalAtArrival=149413}
1369933844607|X|2| 3: (3,{1})::ZI::arrivalTime=6, pv=[[13789, 838]] ... 
params={bidRange=2000, marketID=-1, arrivalTime=6, seed=2413135968883302395, 
fundamentalAtArrival=146299}
1369933844607|X|2| 4: (4,{1})::ZI::arrivalTime=25, pv=[[12627, 5135]] ... 
params={bidRange=2000, marketID=-1, arrivalTime=25, seed=1167348736068771780, 
fundamentalAtArrival=110522}
1369933844608|X|2| 5: (5,{1})::ZI::arrivalTime=36, pv=[[8643, 2744]] ... 
params={bidRange=2000, marketID=-1, arrivalTime=36, seed=-2222894510176179867, 
fundamentalAtArrival=79820}
1369933844608|X|2| 6: (1,{2})::ZI::arrivalTime=1, pv=[[809, -15701]] ... 
params={bidRange=2000, marketID=-2, arrivalTime=1, seed=1511539776185465446, 
fundamentalAtArrival=129299}
1369933844608|X|2| 7: (2,{2})::ZI::arrivalTime=4, pv=[[6490, -8052]] ... 
params={bidRange=2000, marketID=-3, arrivalTime=4, seed=-8400005381541772898, 
fundamentalAtArrival=149413}
1369933844608|X|2| 8: (3,{2})::ZI::arrivalTime=6, pv=[[13789, 838]] ... 
params={bidRange=2000, marketID=-2, arrivalTime=6, seed=2413135968883302395, 
fundamentalAtArrival=146299}
1369933844608|X|2| 9: (4,{2})::ZI::arrivalTime=25, pv=[[12627, 5135]] ... 
params={bidRange=2000, marketID=-3, arrivalTime=25, seed=1167348736068771780, 
fundamentalAtArrival=110522}
1369933844608|X|2| 10: (5,{2})::ZI::arrivalTime=36, pv=[[8643, 2744]] ... 
params={bidRange=2000, marketID=-2, arrivalTime=36, seed=-2222894510176179867, 
fundamentalAtArrival=79820}
1369933844608|X|2| 11: (6,{2})::LA::arrivalTime=0 ... params={sleepVar=100, 
sleepTime=0, seed=4181524093244964785, alpha=0.001}
1369933844608|X|2| 12: (1,{3})::ZI::arrivalTime=1, pv=[[809, -15701]] ... 
params={bidRange=2000, marketID=-4, arrivalTime=1, seed=1511539776185465446, 
fundamentalAtArrival=129299}
.
.
.
1369933844609|X|2| 22: (5,{4})::ZI::arrivalTime=36, pv=[[8643, 2744]] ... 
params={bidRange=2000, marketID=-6, arrivalTime=36, seed=-2222894510176179867, 
fundamentalAtArrival=79820}
1369933844609|X|2|------------------------------------------------
\end{verbatim}

Explanations of some select lines:
\begin{description}
\item \verb|1: (1,{1})::ZI::arrivalTime=1, pv=[[809, -15701]]| --- initializes a ZI agent within market model 1 with agentID=1, logID=1, arrival time of 1 and private valuation vector of 101525

\item \verb|6: (1,{2})::ZI::arrivalTime=1, pv=[[809, -15701]]| --- initializes a ZI agent with the same pseudorandom number generator seed but in market model 2 with agentID=6, logID=1 (the same as before), and the same arrival time/private value.

\item \verb|11: (6,{2})::LA::arrivalTime=0| --- initializes the latency arbitrageur with agentID=11 and logID=6. Note that LA is only initialized for market model 2.
\end{description}

In the simulator, \verb|params| is a general-purpose container for storing parameters and associated values during entity creation and initialization. These may be strategy parameters set in the specification file or the common random numbers stored for agent populations.


\section{Market simulation}

After market models, markets, and agents are created, the simulation begins running.
Each line will have a timestamp (which is the number following the first 18 characters).
For example, in 
\begin{verbatim}
1369933844610|X|2|0 | (1,{2})->[-2],[-3]
\end{verbatim}
the first section \verb+1369933844610|X|2|+ can be ignored, and the timestamp here is 0.

In general, agents in the log files are referred to by log ID and market model (e.g., \verb|(1,{2})| is agent with log ID 1 in market model 2) as this simplifies the comparison of agent behavior across models.
Some of the types of activities that will be logged:
%
\begin{description}

\item[Arrival] Agent with log ID 1 in market model 2 arrives in markets --2 and --3.
\begin{verbatim}
0 | (1,{2})->[-2],[-3]
\end{verbatim}
\item[Communication with SIP] See first tutorial for explanation of these activities. The last line gives the updated NBBO quote after the execution of these activities. Any price of \verb|-1| means that it is undefined. In the following example, the activities are executed by market --6.
The NBBO quote is represented as being the best between multiple markets by multiple IDs within square brackets, e.g., \verb|[-2,-3]| (see last line).
\begin{verbatim}
0 | [-6] SendToSIP(-1, -1)
0 | [-6] ProcessQuote: (Bid: -1, Ask: -1)
0 | [-6] UpdateNBBO: current (Bid: -1, Ask: -1) --> updated NBBO(Bid: -1, Ask: -1)
0 | [-5] SendToSIP(-1, -1)
0 | [-5] ProcessQuote: (Bid: -1, Ask: -1)
0 | [-4, -5] UpdateNBBO: current (Bid: -1, Ask: -1) --> updated NBBO(Bid: -1, Ask: -1)
\end{verbatim}

\item[Updating quotes] These lines just give the updated quotes at timestamp 36 for agent 6 in model 2. Only HFT agents can act on the Global quote (best buy/sell prices in all markets).
Non-HF traders can only act based on knowledge of their primary market and the NBBO quote.
\begin{verbatim}
36 | (6,{2}) Global(Bid: 144052, Ask: 156447), NBBO(Bid: 144052, Ask: 156447)
\end{verbatim}

\item[Bid submission] ZI agent 2 in model 1 submits a bid that will be routed according to Regulation NMS. The bid it submits to market \verb|-1| is an order \verb|(144052,-1)|, i.e. to sell 1 unit (represented by $-1$) at price 144052.
See \verb|SMAgent.java| for details on order routing.
\begin{verbatim}
6 | (3,{1}) ZI::submitNMSBid: +(144052,1) to [-1]
6 | (3,{2}) ZI::submitNMSBid: NBBO(110054, 156447) better than [-2] 
Quote(110054, -1)
\end{verbatim}

\item[Order matching and clearing]
A ZI agent (log ID=5) in model 1 (centralized CDA market model) arrives and submits an order to sell 1 unit at price 91109 at timestamp 36. There is only one market in the model (with ID=--1).
\begin{verbatim}
36 | (5,{1}) ZI::submitNMSBid: NBBO(144052, 156447) worse than/same as [-1] 
Quote(144052, 156447)
36 | (5,{1}) ZI::submitBid: +(91109, -1) to [-1]
\end{verbatim}
%
%
The submitted order matches with an order to buy at price 144052. Note that \verb|5:(-1 91109)| indicates that agent with logID=5 submitted the newest order. \verb|MB| gives the list of matching buy orders, \verb|MS| gives the list of matching sells. Since this is a CDA, the transaction clears at the price of the incumbent order (144052).
%
\begin{verbatim}
36 | [-1] Active bids: (1 110054) (-1 156447) (1 144052) (1 111727) (-1 91109)
36 | [-1] FourHeap::logSets::Buys: 4:(1 111727)1:(1 110054) Sells: 2:(-1 156447) 
MB:   size: 1 3:(1 144052) MS:   size: 1 5:(-1 91109)
36 | [-1] Prior-clear Quote(Bid: 111727, Ask: 144052)
36 | [-1] Quantity=1 cleared at Price=144052
\end{verbatim}
%
%
The agent processes the transaction:
\begin{verbatim}
36 | (3,{1}) Agent::updateTransactions: New transaction received: (mktID=-1, 
transID=0 buyer=3, seller=5, price=144052, quantity=1, timeStamp=36)
36 | (3,{1}) Agent::updateTransactions: BUYER surplus: ([[13789, 838]]+79820)
-144052=-63394, SELLER surplus: 144052-([[8643, 2744]]+79820)=55589
36 | (3,{1}) Agent::updateTransactions: SURPLUS: -7805
36 | (3,{1}) Agent::logTransactions: CENTRALCDA: Current Position=1, Realized 
Profit=0
36 | (5,{1}) Agent::updateTransactions: New transaction received: (mktID=-1, 
transID=0 buyer=3, seller=5, price=144052, quantity=1, timeStamp=36)
36 | (5,{1}) Agent::updateTransactions: BUYER surplus: ([[13789, 838]]+79820)
-144052=-63394, SELLER surplus: 144052-([[8643, 2744]]+79820)=55589
36 | (5,{1}) Agent::updateTransactions: SURPLUS: -7805
36 | (5,{1}) Agent::logTransactions: CENTRALCDA: Current Position=-1, Realized 
Profit=0
\end{verbatim}

%
The matching orders have been removed from the order book (the \verb|MB| and \verb|MS| lists are now both empty):
\begin{verbatim}
36 | [-2] Active bids: (1 110054) (0 144052) (0 91109)
36 | [-2] Cleared bids: (0 144052) (0 91109)
36 | [-2] FourHeap::logSets::Buys: 6:(1 110054) Sells:  MB:   size: 0  MS:   size: 0
36 | .....[-2] CDAMarket::clear: Order book cleared: Post-clear Quote(Bid: 110054, 
Ask: -1)
\end{verbatim}

\end{description}




\end{document}






